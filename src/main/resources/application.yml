server:
  port: ${SERVER_PORT:9000}

spring:
  application:
    name: trading-gateway

  cloud:
    gateway:
      # HTTP client timeout configuration
      # Increase timeouts for long-running operations like crawling
      httpclient:
        connect-timeout: 5000 # 5 seconds for connection
        response-timeout: 60s # 60 seconds for response (crawler needs time)
        pool:
          type: elastic
          max-idle-time: 60s

      # Global CORS configuration
      # Supports wildcard (*) or specific origins via CORS_ALLOWED_ORIGINS
      # Note: When using "*", credentials are automatically disabled
      # For specific origins, use comma-separated list: "http://localhost:3000,http://frontend:3000"
      globalcors:
        cors-configurations:
          "[/**]":
            # Spring Cloud Gateway supports both allowedOrigins and allowedOriginPatterns
            # Using allowedOriginPatterns to support wildcard "*"
            allowedOriginPatterns: ${CORS_ALLOWED_ORIGINS:http://localhost:3000}
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
            # Credentials only work with specific origins, not wildcard
            allowCredentials: ${CORS_ALLOW_CREDENTIALS:true}
            maxAge: 3600

      # Route configurations
      routes:
        # ============================================
        # Authentication Service Routes (Public)
        # ============================================
        - id: auth-public-register
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/register
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: auth-public-login
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/login
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: auth-public-refresh
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/refresh-token
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        # ============================================
        # Authentication Service Routes (Protected)
        # ============================================
        - id: auth-protected-me
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/me
            - Method=GET
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: auth-protected-change-password
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/change-password
            - Method=POST
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: auth-protected-logout
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/logout
            - Method=POST
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: auth-protected-upgrade-account
          uri: ${auth.service.url:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/upgrade-account
            - Method=PUT
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        # ============================================
        # Protected Internal Services
        # These services MUST be accessed through the gateway
        # Direct access should be blocked by network policies
        # ============================================
        - id: price-prediction-service
          uri: ${price.prediction.service.url:http://localhost:8082}
          predicates:
            - Path=/api/v1/predictions/**
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: predictionServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: portfolio-backtest-service
          uri: ${portfolio.backtest.service.url:http://localhost:8083}
          predicates:
            - Path=/api/v1/backtest/**
          filters:
            - AuthenticationFilter
            - name: CircuitBreaker
              args:
                name: backtestServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        # ============================================
        # Crawl/News Service Routes
        # Note: Increased timeout for crawling operations (60s)
        # ============================================
        - id: news-service
          uri: ${crawl.service.url:http://localhost:9002}
          predicates:
            - Path=/api/v1/news/**
          filters:
            - name: CircuitBreaker
              args:
                name: newsServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: crawler-service
          uri: ${crawl.service.url:http://localhost:9002}
          predicates:
            - Path=/api/v1/crawler/**
          filters:
            - name: CircuitBreaker
              args:
                name: newsServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: cronjob-service
          uri: ${crawl.service.url:http://localhost:9002}
          predicates:
            - Path=/api/v1/cronjob/**
          filters:
            - name: CircuitBreaker
              args:
                name: newsServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: ai-analysis-service
          uri: ${crawl.service.url:http://localhost:9002}
          predicates:
            - Path=/api/v1/ai/**
          filters:
            - AuthenticationFilter
            - VipAuthorizationFilter
            - name: CircuitBreaker
              args:
                name: newsServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

        - id: analytics-service
          uri: ${crawl.service.url:http://localhost:9002}
          predicates:
            - Path=/api/v1/analytics/**
          filters:
            - AuthenticationFilter
            - VipAuthorizationFilter
            - name: CircuitBreaker
              args:
                name: newsServiceCircuitBreaker
                fallbackUri: forward:/fallback/service
                statusCodes:
                  - 500
                  - 502
                  - 503
                  - 504

# Authentication service configuration
auth:
  service:
    url: ${AUTH_SERVICE_URL:http://localhost:8081}

# Other service URLs
price:
  prediction:
    service:
      url: ${PRICE_PREDICTION_SERVICE_URL:http://localhost:8082}

portfolio:
  backtest:
    service:
      url: ${PORTFOLIO_BACKTEST_SERVICE_URL:http://localhost:8083}

crawl:
  service:
    url: ${CRAWL_SERVICE_URL:http://localhost:9002}

# Gateway security configuration
gateway:
  security:
    secret: ${GATEWAY_SECRET:change-this-in-production}

# Resilience4j Circuit Breaker configuration
# Configure to pass through client errors (4xx) instead of triggering fallback
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s # Increased from 5s to 10s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        slowCallDurationThreshold: 45s # Consider calls slower than 45s as slow
        slowCallRateThreshold: 80 # Open circuit if 80% of calls are slow
        # Only record server errors (5xx) as failures, not client errors (4xx)
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.reactive.function.client.WebClientResponseException$ServiceUnavailable
          - org.springframework.web.reactive.function.client.WebClientResponseException$GatewayTimeout
          - org.springframework.web.reactive.function.client.WebClientResponseException$InternalServerError
        ignoreExceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException$BadRequest
          - org.springframework.web.reactive.function.client.WebClientResponseException$Unauthorized
          - org.springframework.web.reactive.function.client.WebClientResponseException$Forbidden
          - org.springframework.web.reactive.function.client.WebClientResponseException$NotFound
    instances:
      authServiceCircuitBreaker:
        baseConfig: default
      predictionServiceCircuitBreaker:
        baseConfig: default
      backtestServiceCircuitBreaker:
        baseConfig: default
      newsServiceCircuitBreaker:
        baseConfig: default
        slidingWindowSize: 20 # More samples before opening circuit
        minimumNumberOfCalls: 10 # Need more calls before evaluating
        failureRateThreshold: 70 # Higher threshold for news service (crawling can be flaky)

# Logging configuration for security audit
logging:
  level:
    root: ${LOGGING_LEVEL_ROOT:INFO}
    com.hpt.trading_gateway: ${LOGGING_LEVEL_GATEWAY:DEBUG}
    org.springframework.cloud.gateway: ${LOGGING_LEVEL_GATEWAY:DEBUG}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/gateway.log

# Management endpoints for monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
